(() => {
  const QUOTA_ENDPOINT = (msisdn) =>
    `https://leonskennedy.my.id/cekcircle/cek_kuota.php?msisdn=${encodeURIComponent(msisdn)}`;

  const MEMBERSHIP_ENDPOINT = (msisdn) =>
    `https://leonskennedy.my.id/cekcircle/cek_membership.php?msisdn=${encodeURIComponent(msisdn)}`;

  const MSISDN_RE = /^62\d{6,14}$/;

  function clearAlert(containerEl, id) {
    const old = containerEl.querySelector(`#${id}`);
    if (old) old.remove();
  }

  function showAlert(containerEl, { id, type = "danger", html = "" }) {
    clearAlert(containerEl, id);

    const box = document.createElement("div");
    box.className = `alert alert-${type} mt-3`;
    box.id = id;

    // NOTE:
    // Kamu sebelumnya pakai innerHTML karena response error mengandung <br> / <img>.
    // Ini dipertahankan. Pastikan endpoint kamu trusted (atau sanitasi) biar aman.
    box.innerHTML = html;

    containerEl.appendChild(box);
  }

  // ========== Kuota ==========
  const msisdn = document.getElementById("msisdn");
  const btnCheck = document.getElementById("btnCheck");
  const state = document.getElementById("state");
  const result = document.getElementById("result");

  async function fetchQuota(msisdnVal) {
    state.textContent = "Mengambil data kuota...";
    result.classList.add("d-none");
    clearAlert(state.parentElement, "errorBoxQuota");

    try {
      const res = await fetch(QUOTA_ENDPOINT(msisdnVal));
      const data = await res.json();

      if (!data.ok) {
        state.textContent = "";
        result.classList.add("d-none");
        showAlert(state.parentElement, {
          id: "errorBoxQuota",
          type: "danger",
          html: data.error || "Gagal mengambil data kuota.",
        });
        return;
      }

      const q = data.quota;
      const lc = data.lifecycle;

      // Pakai allocation.label kalau ada (fallback ke `${gb} GB`)
      const allocLabel = q?.allocation?.label ?? `${q.allocation.gb} GB`;

      document.getElementById("r_msisdn").textContent = data.msisdn;
      document.getElementById("r_alloc").textContent = allocLabel;
      document.getElementById("r_used").textContent = `${q.used.gb} GB (${q.usage_pct}%)`;
      document.getElementById("r_remain").textContent = `${q.remaining.gb} GB`;
      document.getElementById("r_join").textContent = lc.joined;
      document.getElementById("r_exp").textContent = lc.expires;

      // Progress bar
      const bar = document.getElementById("r_progress");
      bar.style.width = `${q.usage_pct}%`;
      bar.textContent = `${q.usage_pct}%`;

      // Dinamis warna (berdasarkan sisa)
      const remainPct = 100 - q.usage_pct;
      bar.classList.remove("bg-success", "bg-warning", "bg-danger");
      if (remainPct > 50) bar.classList.add("bg-success");
      else if (remainPct > 20) bar.classList.add("bg-warning");
      else bar.classList.add("bg-danger");

      state.textContent = "";
      result.classList.remove("d-none");
    } catch (e) {
      state.textContent = "";
      showAlert(state.parentElement, {
        id: "errorBoxQuota",
        type: "danger",
        html: `Error: ${e.message}`,
      });
    }
  }

  btnCheck.addEventListener("click", () => {
    const v = msisdn.value.trim();
    if (!MSISDN_RE.test(v)) {
      state.textContent = "Masukkan MSISDN valid (diawali 62).";
      result.classList.add("d-none");
      clearAlert(state.parentElement, "errorBoxQuota");
      return;
    }
    fetchQuota(v);
  });

  // ========== Membership ==========
  const msisdnMember = document.getElementById("msisdnMember");
  const btnMember = document.getElementById("btnMember");
  const stateMember = document.getElementById("stateMember");
  const resultMember = document.getElementById("resultMember");

  async function fetchMembership(msisdnVal) {
    stateMember.textContent = "Mengambil data membership...";
    resultMember.classList.add("d-none");
    clearAlert(stateMember.parentElement, "errorBoxMember");

    try {
      const res = await fetch(MEMBERSHIP_ENDPOINT(msisdnVal));
      const data = await res.json();

      if (!data.ok) {
        stateMember.textContent = "";
        resultMember.classList.add("d-none");
        showAlert(stateMember.parentElement, {
          id: "errorBoxMember",
          type: "danger",
          html: data.error || "Gagal mengambil data membership.",
        });
        return;
      }

      document.getElementById("m_msisdn").textContent = data.msisdn;
      const statusEl = document.getElementById("m_status");
      statusEl.textContent = data.membership.status_text;
      statusEl.style.color = data.membership.status_color;

      stateMember.textContent = "";
      resultMember.classList.remove("d-none");
    } catch (e) {
      stateMember.textContent = "";
      showAlert(stateMember.parentElement, {
        id: "errorBoxMember",
        type: "danger",
        html: `Error: ${e.message}`,
      });
    }
  }

  btnMember.addEventListener("click", () => {
    const v = msisdnMember.value.trim();
    if (!MSISDN_RE.test(v)) {
      stateMember.textContent = "Masukkan MSISDN valid (diawali 62).";
      resultMember.classList.add("d-none");
      clearAlert(stateMember.parentElement, "errorBoxMember");
      return;
    }
    fetchMembership(v);
  });
})();
